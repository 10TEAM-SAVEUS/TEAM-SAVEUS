"use client";
import { useEffect, useState } from "react";
import Footer from "@/components/common/Footer";
import Header from "@/components/common/Header";
import Image from "next/image";
import rightarrow from "../../assets/rightarrow.svg";
import emptyPin from "../../assets/emptyPin.svg";
import shareFat from "../../assets/shareFat.svg";
import cnnvdReport from "../../assets/first_card_large_Image.svg";
import newProduct from "../../assets/second_card_large_Image.svg";
import ciscoCnnvdReport from "../../assets/third_card_large_Image.svg";
import magnifyingGlass from "../../assets/magnifyingGlass.svg";
import { useRouter } from "next/navigation"; // App Router에서는 next/navigation 사용
import { db } from "../../firebase/setting"; // Firestore import
import {
  collection,
  getDocs,
  query,
  orderBy,
  limit,
  doc,
  updateDoc,
} from "firebase/firestore";

export default function VulnerabilityPage() {
  const [reports, setReports] = useState<any[]>([]); // 전체 기사 목록
  const [recentReports, setRecentReports] = useState<any[]>([]); // 배너에 표시할 최신 보고서
  const [currentPage, setCurrentPage] = useState(1); // 현재 페이지
  const [searchTerm, setSearchTerm] = useState(""); // 검색어
  const pageSize = 10; // 한 페이지에 보여줄 기사 수
  const [filteredReports, setFilteredReports] = useState<any[]>([]); // 필터된 기사 목록
  const [selectedButton, setSelectedButton] = useState(""); // 현재 선택된 버튼 상태
  const router = useRouter();

  // 크롤링된 날짜로부터 며칠이 지났는지 계산하는 함수
  const calculateDaysAgo = (crawlingDate: Date) => {
    const currentDate = new Date();
    const differenceInTime = currentDate.getTime() - crawlingDate.getTime();
    const differenceInDays = Math.floor(differenceInTime / (1000 * 3600 * 24)); // 하루 밀리초 수로 나눔
    return differenceInDays === 0 ? "오늘" : `${differenceInDays}일 전`;
  };

  useEffect(() => {
    const fetchReports = async () => {
      // Firestore에서 ReleaseDate를 기준으로 최신순으로 정렬된 데이터 가져오기
      const reportsQuery = query(
        collection(db, "Reports"),
        orderBy("ReleaseDate", "desc")
      );

      const querySnapshot = await getDocs(reportsQuery);
      const reportsData = querySnapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      }));

      setReports(reportsData);
      setFilteredReports(reportsData); // 초기 상태에서는 전체 기사 표시
    };

    const fetchRecentReports = async () => {
      // Firestore에서 CrawlingDate를 기준으로 최신 3개의 보고서를 가져오기
      const recentReportsQuery = query(
        collection(db, "Reports"),
        orderBy("CrawlingDate", "desc"),
        limit(3)
      );

      const querySnapshot = await getDocs(recentReportsQuery);
      const recentReportsData = querySnapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      }));

      setRecentReports(recentReportsData);
    };

    fetchReports();
    fetchRecentReports();
  }, []);

  // 페이지 변경 핸들러
  const handlePageChange = (newPage: number) => {
    setCurrentPage(newPage);
  };

  // 보고서 클릭 시 페이지 이동
  const handleClick = (id: string) => {
    router.push(`/vulnerabilityDB/${id}`);
  };

  // 검색어 처리 함수
  const handleSearch = () => {
    if (searchTerm.trim() === "") {
      // 검색어가 없을 경우 전체 기사 표시
      setFilteredReports(reports);
      setCurrentPage(1); // 검색어가 없으면 페이지를 1로 초기화
    } else {
      // 검색어가 있을 경우 해당 검색어를 포함하는 기사 필터링
      const filtered = reports.filter((report) =>
        report.Title.includes(searchTerm)
      );
      setFilteredReports(filtered);
      setCurrentPage(1); // 검색어 입력 시 페이지를 1로 초기화
    }
  };

  // 검색어 입력 시 처리
  const handleSearchTermChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setSearchTerm(e.target.value);
    if (e.target.value === "") {
      // 검색어가 비었을 때 전체 기사로 리셋하고 페이지를 1로 초기화
      setFilteredReports(reports);
      setCurrentPage(1);
    }
  };

  // 엔터 키 처리
  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === "Enter") {
      handleSearch();
    }
  };

  // 필터링된 리스트에 대해 현재 페이지에 맞는 데이터 슬라이싱
  const currentFilteredReports = filteredReports.slice(
    (currentPage - 1) * pageSize,
    currentPage * pageSize
  );

  const handleButtonClick = (buttonType: string) => {
    setSelectedButton(buttonType);
  };

  // Firestore Timestamp를 Date 객체로 변환하는 함수
  const convertTimestampToDate = (timestamp: any) => {
    if (timestamp && timestamp.seconds) {
      return new Date(timestamp.seconds * 1000);
    }
    return null;
  };

  const handleCopyUrl = (reportId: string) => {
    const url = `${window.location.origin}/vulnerabilityDB/${reportId}`; // 현재 도메인에 해당 보고서의 상세 페이지 URL을 생성
    navigator.clipboard.writeText(url).then(
      () => {
        alert("URL이 복사되었습니다!"); // 성공적으로 복사되면 알림
      },
      (err) => {
        console.error("URL 복사 실패: ", err);
      }
    );
  };

  const totalPages = Math.ceil(filteredReports.length / pageSize);

  return (
    <>
      <Header />
      <main className="flex flex-col items-center">
        {/* 상단 이미지 배너 섹션 */}
        <section
          className="w-[1313px] h-[390px] flex justify-between mt-[27px]"
          aria-labelledby="featured-reports"
        >
          <h2 id="featured-reports" className="sr-only">
            Featured Reports
          </h2>
          {recentReports.map((report, index) => (
            <div
              key={report.id}
              className="group relative flex-shrink-0 h-full mr-[28px] transition-all duration-300 cursor-pointer"
              onClick={() => handleClick(report.id)}
            >
              <Image
                src={
                  index === 0
                    ? cnnvdReport
                    : index === 1
                    ? newProduct
                    : ciscoCnnvdReport
                }
                alt={`[취약성 경고] ${report.Title}`}
                width={316}
                height={390}
                className="object-cover h-full w-[316px] group-hover:w-[625px] rounded-3xl transition-all duration-300"
              />
              <div className="absolute bottom-8 left-2 text-white p-2 rounded-md">
                <h3 className="text-lg font-semibold">{report.Title}</h3>
                <p className="text-sm text-[#969696] w-[90px] h-[44px]">
                  {" "}
                  {new Date(report.ReleaseDate.seconds * 1000).toLocaleString()}
                </p>
              </div>
              <button className="absolute bottom-4 right-4 rounded-full p-1 shadow-md">
                <Image
                  src={rightarrow}
                  alt="가장 최신으로 업데이트된 보고서 보러가기"
                  width={68}
                  height={68}
                />
              </button>
            </div>
          ))}
        </section>

        <section className="w-[1313px] h-[82px] flex items-center mt-[76px] gap-2.5">
          <div className="w-full h-full p-[2px] relative bg-white bg-gradient-to-r from-[#6100FF] to-[#4F6BFF] rounded-lg flex items-center">
            <input
              type="text"
              value={searchTerm}
              onChange={handleSearchTermChange} // 검색어 변경 처리
              onKeyPress={handleKeyPress} // 엔터 키를 눌렀을 때 검색
              className="flex-grow h-full px-4 py-2 border-none rounded-lg text-xl bg-white text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-300 ease-in-out"
              placeholder="검색어를 입력해주세요."
            />
            <button className="absolute right-6" onClick={handleSearch}>
              {" "}
              {/* 검색 버튼 클릭 시 검색 */}
              <Image
                src={magnifyingGlass}
                alt="검색하기 버튼"
                width={32}
                height={32}
                className="ml-6"
              />
            </button>
          </div>
        </section>

        {/* 취약점 DB 섹션 */}
        <section
          className="w-[1313px] flex mt-[76px]"
          aria-labelledby="vulnerability-db"
        >
          <div className="flex-1">
            <h2
              id="vulnerability-db"
              className="text-[24px] font-semibold leading-[29.05px] tracking-[-0.01em] mb-4"
            >
              취약점 DB
            </h2>
            <div className="flex mb-4">
              <button
                onClick={() => handleButtonClick("HOT")}
                className={`flex w-[59px] h-[35px] pt-2.5 pr-3 py-2.5 pl-3 gap-2.5 rounded-full items-center text-[16px] font-semibold mr-3 ${
                  selectedButton === "HOT"
                    ? "bg-[#FF6D6D] text-white"
                    : "bg-[#E8E8E8] text-[#ADADAD]"
                }`}
              >
                HOT
              </button>
              <button
                onClick={() => handleButtonClick("NEW")}
                className={`flex w-[62px] h-[35px] pt-2.5 pr-3 py-2.5 pl-3 gap-2.5 rounded-full items-center text-[16px] font-semibold ${
                  selectedButton === "NEW"
                    ? "bg-[#6DB0FF] text-white"
                    : "bg-[#E8E8E8] text-[#ADADAD]"
                }`}
              >
                NEW
              </button>
            </div>
            {filteredReports.length > 0 ? (
              <ul>
                {currentFilteredReports.map((report) => (
                  <li
                    key={report.id}
                    className="w-[865px] h-[258px] border border-solid border-[#C3C3C3] rounded-lg mb-4 cursor-pointer"
                    onClick={() => handleClick(report.id)}
                  >
                    <article>
                      <header className="flex pl-7 pt-7 pb-2">
                        <span className="flex bg-[#FF6D6D] w-[59px] h-[35px] pt-2.5 pr-3 py-2.5 pl-3 gap-2.5 rounded-full items-center text-white text-[16px] font-semibold mr-2">
                          HOT
                        </span>
                        <h3 className="flex items-end font-normal text-xl">
                          {report.Title}
                        </h3>
                      </header>
                      <span className="w-[71px] h-[19] text-[16px] font-normal leading-[19.36px] tracking-[-0.01em] text-[#ADADAD] pl-7">
                        {convertTimestampToDate(
                          report.ReleaseDate
                        )?.toLocaleString()}
                      </span>
                      <div className="pl-7 pt-[24px] gap-2 whitespace-nowrap">
                        <p className="w-[809px] pt-5 pr-7 pb-5 pl-5 font-normal text-[#797979] text-[16px] bg-[#FAF8FF] rounded-[16px] overflow-hidden whitespace-nowrap text-ellipsis">
                          {report.MainContent.slice(0, 100)}...
                        </p>
                      </div>
                      <footer className="flex justify-between pt-6">
                        <div className="flex pl-7">
                          <button className="pr-3">
                            <Image
                              src={emptyPin}
                              alt="고정 핀 제거 상태"
                              width={28}
                              height={28}
                            />
                          </button>
                          <button onClick={() => handleCopyUrl(report.id)}>
                            <Image
                              src={shareFat}
                              alt="URL 복사 버튼"
                              width={28}
                              height={28}
                            />
                          </button>
                        </div>
                        <time className="pr-7">
                          {calculateDaysAgo(
                            new Date(report.CrawlingDate.seconds * 1000)
                          )}
                        </time>
                      </footer>
                    </article>
                  </li>
                ))}
              </ul>
            ) : (
              <p className="text-center text-gray-500">검색결과가 없습니다.</p>
            )}
            {/* 페이지네이션 UI */}
            {filteredReports.length > 0 && (
              <div className="flex justify-center items-center mt-[76px] mb-[196px] space-x-2">
                <button
                  onClick={() => handlePageChange(currentPage - 1)}
                  disabled={currentPage === 1}
                  className="w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full text-gray-600 disabled:opacity-50"
                >
                  &lt;
                </button>
                {Array.from({ length: totalPages }, (_, index) => (
                  <button
                    key={index}
                    onClick={() => handlePageChange(index + 1)}
                    className={`w-8 h-8 flex items-center justify-center rounded-full ${
                      currentPage === index + 1
                        ? "bg-blue-600 text-white"
                        : "bg-gray-200 text-gray-600"
                    }`}
                  >
                    {index + 1}
                  </button>
                ))}
                <button
                  onClick={() => handlePageChange(currentPage + 1)}
                  disabled={currentPage === totalPages}
                  className="w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full text-gray-600 disabled:opacity-50"
                >
                  &gt;
                </button>
              </div>
            )}
          </div>

          {/* 오른쪽 섹션: 실시간 Topic */}
          <aside className="w-[346px] ml-8" aria-labelledby="real-time-topic">
            <h2 id="real-time-topic" className="font-semibold text-[24px]">
              실시간 Topic
            </h2>
            <p className="font-medium text-lg text-[#969696] pt-[17px] pb-4">
              03.08 10:00시 기준
            </p>
            <ol className="p-[20px] rounded-[8px] border border-solid pt-5 pl-[20px] list-decimal list-inside">
              <li className="font-medium text-lg text-[#6100FF] pt-4 pb-4 border-b border-b-[#E6E6E6]">
                Topic
              </li>
              <li className="font-medium text-lg text-[#3F3F3F] pt-4 pb-4 border-b border-b-[#E6E6E6]">
                웹뷰 프레임 워크
              </li>
              <li className="font-medium text-lg text-[#3F3F3F] pt-4 pb-4 border-b border-b-[#E6E6E6]">
                허프만 코딩 구현
              </li>
              <li className="font-medium text-lg text-[#3F3F3F] pt-4 pb-4 border-b border-b-[#E6E6E6]">
                테스크 커버리지
              </li>
              <li className="font-medium text-lg text-[#3F3F3F] pt-4 pb-4 border-b border-b-[#E6E6E6]">
                코드형 인프라(IaC)
              </li>
              <li className="font-medium text-lg text-[#3F3F3F] pt-4 pb-4 border-b border-b-[#E6E6E6]">
                클린 아키텍쳐
              </li>
              <li className="font-medium text-lg text-[#3F3F3F] pt-4 pb-4 border-b border-b-[#E6E6E6]">
                UI 라이브러리 개발
              </li>
              <li className="font-medium text-lg text-[#3F3F3F] pt-4 pb-4 border-b border-b-[#E6E6E6]">
                AWS Personalize
              </li>
              <li className="font-medium text-lg text-[#3F3F3F] pt-4 pb-4 border-b border-b-[#E6E6E6]">
                키클락
              </li>
              <li className="font-medium text-lg text-[#3F3F3F] pt-4 pb-4 border-b border-b-[#E6E6E6]">
                클린 코어
              </li>
            </ol>
          </aside>
        </section>
      </main>
      <Footer />
    </>
  );
}
